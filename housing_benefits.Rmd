---
title: "How much housing benefits decrease housing precarity?"
author: "Michael Škvrňák"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(Hmisc)
library(ggplot2)
library(targets)
library(haven)
```

# Descriptives

## Housing precarity

```{r}
tar_load(silc_merged)
tar_load(silc_merged_households)
```

## Effect of housing benefits on housing overburden

Comparison of housing precarity dimensions with and without housing benefits can be made easily only for housing overburden (by calculating overburden based on income with housing benefits and without housing benefits). This assumes that the households would not move if they did not receive housing benefits.
Comparison of other dimensions require some modelling. 

```{r, fig.width=10, fig.height=10}
tar_load(all_silc_households)
all_silc_households %>% 
  select(country, year, mean_housing_overburden, mean_housing_overburden_wo_hb) %>% 
  pivot_longer(., cols = 3:4, names_to = "type", values_to = "pct") %>% 
  mutate(type = case_when(
    grepl("wo_hb", type) ~ "Without housing benefits",
    !grepl("wo_hb", type) ~ "With housing benefits"
  )) %>% 
  ggplot(., aes(x = year, y = pct, colour = type)) + 
  geom_point(alpha = 0.8) + 
  scale_colour_viridis_d() + 
  facet_wrap(~country, scales = "free_y") + 
  theme_minimal() + 
  labs(x = "Year", y = "Share of households", 
       title = "Housing overburden", 
       colour = "") + 
  theme(legend.position = "top")
```

```{r}
silc_merged_households %>% 
  ungroup() %>% 
  filter(year == 2023) %>% 
  select(country, hh_id, income_share_on_housing, income_share_on_housing_wo_hb) %>% 
  pivot_longer(., cols = c(income_share_on_housing, income_share_on_housing_wo_hb), 
               names_to = "income_type", values_to = "income_share_on_housing") %>% 
  mutate(income_type = if_else(income_type == "income_share_on_housing", 
                               "With housing benefits", 
                               "Without housing benefits")) %>% 
  ggplot(., aes(x = income_share_on_housing, colour = income_type)) + 
  geom_density() + 
  facet_wrap(~country, scales = "free_y") + 
  theme_minimal() + 
  labs(x = "Income share on housing", y = "Density", colour = "Income") + 
  theme(legend.position = "top")
  
```

```{r}
silc_merged_households %>% 
  ungroup() %>% 
  filter(year == 2023) %>% 
  select(country, hh_id, income_share_on_housing, income_share_on_housing_wo_hb, 
         hh_cross_weight) %>% 
  mutate(diff_pp = income_share_on_housing_wo_hb - income_share_on_housing) %>% 
  group_by(country) %>% 
  summarise(mean_reduction_income_share = wtd.mean(diff_pp, hh_cross_weight, 
                                                   na.rm = TRUE)) %>% 
  arrange(desc(mean_reduction_income_share)) %>% 
  knitr::kable(., digits = 2, col.names = c("Country", "Mean reduction of income share on housing (perc. points)"))
  
```

### Tenants

```{r, fig.width=10, fig.height=10}
tar_load(all_silc_households_tenants)
all_silc_households_tenants %>% 
  select(country, year, mean_housing_overburden, mean_housing_overburden_wo_hb) %>% 
  pivot_longer(., cols = 3:4, names_to = "type", values_to = "pct") %>% 
  mutate(type = case_when(
    grepl("wo_hb", type) ~ "Without housing benefits",
    !grepl("wo_hb", type) ~ "With housing benefits"
  )) %>% 
  ggplot(., aes(x = year, y = pct, colour = type)) + 
  geom_point(alpha = 0.8) + 
  scale_colour_viridis_d() + 
  facet_wrap(~country, scales = "free_y") + 
  theme_minimal() + 
  scale_y_continuous(labels = scales::label_percent(scale = 1)) + 
  labs(x = "Year", y = "Share of households", 
       title = "Housing overburden", 
       subtitle = "Tenants",
       colour = "") + 
  theme(legend.position = "top")

```

```{r}
silc_merged_households %>% 
  ungroup() %>% 
  filter(year == 2023) %>% 
  filter(tenure_status %in% c("Tenant, rent at market price", 
                              "Tenant, rent at reduced price", 
                              "Tenant, rent free")) %>% 
  select(country, hh_id, income_share_on_housing, income_share_on_housing_wo_hb) %>% 
  pivot_longer(., cols = c(income_share_on_housing, income_share_on_housing_wo_hb), 
               names_to = "income_type", values_to = "income_share_on_housing") %>% 
  mutate(income_type = if_else(income_type == "income_share_on_housing", 
                               "With housing benefits", 
                               "Without housing benefits")) %>% 
  ggplot(., aes(x = income_share_on_housing, colour = income_type)) + 
  geom_density() + 
  facet_wrap(~country, scales = "free_y") + 
  theme_minimal() + 
  labs(x = "Income share on housing", y = "Density", colour = "Income") + 
  theme(legend.position = "top")
  
```

```{r}
silc_merged_households %>% 
  ungroup() %>% 
  filter(year == 2023) %>% 
  filter(tenure_status %in% c("Tenant, rent at market price", 
                              "Tenant, rent at reduced price", 
                              "Tenant, rent free")) %>% 
  select(country, hh_id, income_share_on_housing, income_share_on_housing_wo_hb, 
         hh_cross_weight) %>% 
  mutate(diff_pp = income_share_on_housing_wo_hb - income_share_on_housing) %>% 
  group_by(country) %>% 
  summarise(mean_reduction_income_share = wtd.mean(diff_pp, hh_cross_weight, 
                                                   na.rm = TRUE)) %>% 
  arrange(desc(mean_reduction_income_share)) %>% 
  knitr::kable(., digits = 2, col.names = c("Country", "Mean reduction of income share on housing (perc. points)"))
```

### Owners

```{r, fig.width=10, fig.height=10}
tar_load(all_silc_households_owners)
all_silc_households_owners %>% 
  select(country, year, mean_housing_overburden, mean_housing_overburden_wo_hb) %>% 
  pivot_longer(., cols = 3:4, names_to = "type", values_to = "pct") %>% 
  mutate(type = case_when(
    grepl("wo_hb", type) ~ "Without housing benefits",
    !grepl("wo_hb", type) ~ "With housing benefits"
  )) %>% 
  ggplot(., aes(x = year, y = pct, colour = type)) + 
  geom_point(alpha = 0.8) + 
  scale_colour_viridis_d() + 
  facet_wrap(~country, scales = "free_y") + 
  theme_minimal() + 
  scale_y_continuous(labels = scales::label_percent(scale = 1)) + 
  labs(x = "Year", y = "Share of households", 
       title = "Housing overburden", 
       subtitle = "Owners",
       colour = "") + 
  theme(legend.position = "top")
```

```{r}
silc_merged_households %>% 
  ungroup() %>% 
  filter(year == 2023) %>% 
  filter(tenure_status %in% c("Owner without outstanding mortgage", 
                              "Owner with outstanding mortgage")) %>% 
  select(country, hh_id, income_share_on_housing, income_share_on_housing_wo_hb) %>% 
  pivot_longer(., cols = c(income_share_on_housing, income_share_on_housing_wo_hb), 
               names_to = "income_type", values_to = "income_share_on_housing") %>% 
  mutate(income_type = if_else(income_type == "income_share_on_housing", 
                               "With housing benefits", 
                               "Without housing benefits")) %>% 
  ggplot(., aes(x = income_share_on_housing, colour = income_type)) + 
  geom_density() + 
  facet_wrap(~country, scales = "free_y") + 
  theme_minimal() + 
  labs(x = "Income share on housing", y = "Density", colour = "Income") + 
  theme(legend.position = "top")
```

```{r}
silc_merged_households %>% 
  ungroup() %>% 
  filter(year == 2023) %>% 
  filter(tenure_status %in% c("Owner without outstanding mortgage", 
                              "Owner with outstanding mortgage")) %>% 
  select(country, hh_id, income_share_on_housing, income_share_on_housing_wo_hb, 
         hh_cross_weight) %>% 
  mutate(diff_pp = income_share_on_housing_wo_hb - income_share_on_housing) %>% 
  group_by(country) %>% 
  summarise(mean_reduction_income_share = wtd.mean(diff_pp, hh_cross_weight, 
                                                   na.rm = TRUE)) %>% 
  arrange(desc(mean_reduction_income_share)) %>% 
  knitr::kable(., digits = 2, col.names = c("Country", "Mean reduction of income share on housing (perc. points)"))

```

### All

```{r}
diff_all <- all_silc_households %>% 
  mutate(diff = mean_housing_overburden_wo_hb - mean_housing_overburden) %>% 
  group_by(country) %>% 
  summarise(mean_diff_overburden = round(mean(diff, na.rm = TRUE), 2), 
            .groups = "drop") %>% 
  arrange(desc(mean_diff_overburden))

diff_tenants <- all_silc_households_tenants %>% 
  mutate(diff = mean_housing_overburden_wo_hb - mean_housing_overburden) %>% 
  group_by(country) %>% 
  summarise(mean_diff_overburden_tenants = round(mean(diff, na.rm = TRUE), 2), 
            .groups = "drop") %>% 
  arrange(desc(mean_diff_overburden_tenants))

diff_owners <- all_silc_households_owners %>% 
  mutate(diff = mean_housing_overburden_wo_hb - mean_housing_overburden) %>% 
  group_by(country) %>% 
  summarise(mean_diff_overburden_owners = round(mean(diff, na.rm = TRUE), 2), 
            .groups = "drop") %>% 
  arrange(desc(mean_diff_overburden_owners))

```

### Average
```{r}
purrr::reduce(list(diff_all, diff_tenants, diff_owners), 
              ~full_join(.x, .y, by = "country")) %>% 
  mutate(ratio = mean_diff_overburden_tenants / mean_diff_overburden_owners) %>% 
  knitr::kable(., col.names = c("Country", "Overburden diff. (all)", 
                                "Overburden diff. (tenants)", 
                                "Overburden diff. (owners)", 
                                "Ratio"), 
               digits = 2)
```

### Income quantiles
```{r}
silc_merged_households %>% 
  ungroup() %>% 
  group_by(country, year, income_disposable_eqi_quantile) %>% 
  filter(!is.na(income_disposable_eqi_quantile)) %>% 
  summarise(housing_overburden = 
              wtd.mean(housing_overburden, hh_cross_weight, 
                       na.rm = TRUE), 
            housing_overburden_wo_hb = 
              wtd.mean(housing_overburden_wo_hb, hh_cross_weight, 
                       na.rm = TRUE), .groups = "drop") %>% 
  select(country, year, income_disposable_eqi_quantile, 
         housing_overburden, housing_overburden_wo_hb) %>% 
  pivot_longer(., cols = c(housing_overburden, 
         housing_overburden_wo_hb), names_to = "overburden", 
         values_to = "share") %>% 
  filter(overburden == "housing_overburden") %>% 
  ggplot(., aes(x = year, y = share, 
                colour = income_disposable_eqi_quantile
                # shape = overburden
                )) + 
  geom_point(alpha = 0.8) + 
  scale_colour_viridis_d() + 
  facet_wrap(~country, scales = "free_y") + 
  theme_minimal() + 
  scale_y_continuous(labels = scales::label_percent(scale = 100)) + 
  labs(x = "Year", y = "Share of households", 
       title = "Housing overburden", 
       colour = "Equalised disposable income") + 
  theme(legend.position = "top")
  
```


```{r}
silc_merged_households %>% 
  ungroup() %>% 
  filter(year == 2023) %>% 
  filter(!is.na(income_disposable_eqi_quantile)) %>% 
  select(country, hh_id, income_share_on_housing, income_share_on_housing_wo_hb, income_disposable_eqi_quantile, 
         hh_cross_weight) %>% 
  mutate(diff_pp = income_share_on_housing_wo_hb - income_share_on_housing) %>% 
  group_by(country, income_disposable_eqi_quantile) %>% 
  summarise(mean_reduction_income_share = wtd.mean(diff_pp, hh_cross_weight, 
                                                   na.rm = TRUE)) %>% 
  ggplot(., aes(x = income_disposable_eqi_quantile, y = mean_reduction_income_share)) + 
  geom_point() + 
  coord_flip() + 
  facet_wrap(~country) + 
  theme_minimal() + 
  labs(y = "Mean reduction of income share on housing (perc. points)", 
       x = "Quantile of equalised disposable income")

```

### Economic activity
```{r}
silc_merged_households %>% 
  ungroup() %>% 
  group_by(country, year, econ_status) %>% 
  filter(!is.na(econ_status)) %>% 
  # filter(econ_status != "Other") %>% 
  mutate(econ_status = case_when(
    econ_status == "Employed" ~ "Employed",
    econ_status == "Retired" ~ "Retired",
    econ_status %in% c("Unemployed", "Fulfilling domestic tasks", 
                       "Unable to work due to health problems") ~ "Inactive (unemployed, unable to work, at home)",
    econ_status %in% c("Student", "Other") ~ "Other",
  )) %>% 
  summarise(housing_overburden = 
              wtd.mean(housing_overburden, hh_cross_weight, 
                       na.rm = TRUE), 
            housing_overburden_wo_hb = 
              wtd.mean(housing_overburden_wo_hb, hh_cross_weight, 
                       na.rm = TRUE), .groups = "drop") %>% 
  select(country, year, econ_status, 
         housing_overburden, housing_overburden_wo_hb) %>% 
  pivot_longer(., cols = c(housing_overburden, 
         housing_overburden_wo_hb), names_to = "overburden", 
         values_to = "share") %>% 
  filter(overburden == "housing_overburden") %>% 
  ggplot(., aes(x = year, y = share, 
                colour = econ_status
                # shape = overburden
                )) + 
  geom_point(alpha = 0.8) + 
  scale_colour_viridis_d() + 
  facet_wrap(~country, scales = "free_y") + 
  theme_minimal() + 
  scale_y_continuous(labels = scales::label_percent(scale = 100)) + 
  labs(x = "Year", y = "Share of households", 
       title = "Housing overburden", 
       colour = "Econ. status") + 
  theme(legend.position = "top")
```


```{r}
silc_merged_households %>% 
  ungroup() %>% 
  filter(year == 2023) %>% 
  filter(!is.na(econ_status)) %>% 
  select(country, hh_id, income_share_on_housing, income_share_on_housing_wo_hb, econ_status, 
         hh_cross_weight) %>% 
  mutate(diff_pp = income_share_on_housing_wo_hb - income_share_on_housing) %>% 
  group_by(country, econ_status) %>% 
  summarise(mean_reduction_income_share = 
              wtd.mean(diff_pp, hh_cross_weight, na.rm = TRUE)) %>% 
  ggplot(., aes(x = econ_status, y = mean_reduction_income_share)) + 
  geom_point() + 
  coord_flip() + 
  facet_wrap(~country) + 
  theme_minimal() + 
  labs(y = "Mean reduction of income share on housing (perc. points)", 
       x = "Econ. status")

```

### Age
```{r}
# TODO:
```

### Education
```{r}
# TODO:
```


## Models of housing overburden

I want to estimate housing overburden/share of income on housing 
```{r}

```

